<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Making your elastic cluster perform</title>

    <meta name="description" content="A presentation explaining the steps to take to run a healthy elastic cluster">
    <meta name="author" content="Jettro Coenradie">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/solarized.css" id="theme">

    <!-- Code syntax highlighting -->
    <!--<link rel="stylesheet" href="lib/css/tomorrow-night-bright.css">-->
    <link rel="stylesheet" href="lib/css/idea.css">
    <!--<link rel="stylesheet" href="node_modules/highlight.js/styles/zenburn.css">-->
    <style>
        .reveal .slides section .fragment.current-only {
            opacity: 1;
            visibility: visible;
            display: none;
        }

        .reveal .slides section .fragment.current-only.current-fragment {
            display: block;
        }

        .line {
            display: block;
        }

        .line.focus {
            background: yellow;
        }
    </style>
    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <!--<section>-->
            <!--<h1>TODO</h1>-->
            <!--<ul>-->
                <!--<li>https://demoneaux.github.io/reveal-code-focus/#/</li>-->
                <!--<li>https://www.elastic.co/elasticon/conf/2016/sf/elasticsearch-and-resiliency</li>-->
                <!--<li>-->
                    <!--https://www.elastic.co/elasticon/conf/2016/sf/stories-from-elastic-support-top-problems-and-solutions-->
                <!--</li>-->
                <!--<li>-->
                    <!--Think about Round robin all requests when connecting with a non java client, check comment in this-->
                    <!--url:-->
                    <!--https://www.elastic.co/guide/en/elasticsearch/guide/2.x/indexing-performance.html#_other-->
                <!--</li>-->
            <!--</ul>-->
        <!--</section>-->
        <section>
            <h1>Making your elastic cluster perform</h1>
            <p>
                <small>Created by <a href="http://twitter.com/jettroCoenradie">@jettroCoenradie</a></small>
            </p>
            <p>
                <img src="/lib/images/luminisams_logo.png">
            </p>
        </section>

        <section>
            <h2>Coming to Elasticsearch</h2>
            <section>
                <div>
                    <div style="float: left; width: 40%;"><img style="background-color: white"
                                                               src="/lib/images/elastic-logo.png"></div>
                    <div>
                        <p></p>
                        <p class="fragment">Providing search to your users</p>
                        <p class="fragment">Log monitoring</p>
                        <p class="fragment">Cool Kibana dashboards</p>
                    </div>
                </div>
            </section>
            <section>
                <img src="/lib/images/comingto/cool-kibana-dashboard.png">
            </section>
        </section>

        <section>
            <h2>Beginning with Elasticsearch</h2>
            <section data-background="/lib/images/elastic-cluster-full-color.jpg">
            </section>
            <section>
                <img src="/lib/images/firststeps/downloading-elasticsearch.png">
            </section>
            <section>
                <img src="/lib/images/firststeps/starting-elasticsearch.png">
            </section>
            <section>
                <pre><code>
curl 'localhost:9200?pretty'
                </code></pre>
<pre><code>
{
  "name" : "Tatterdemalion",
  "cluster_name" : "elasticsearch",
  "version" : {
    "number" : "2.3.1",
    "build_hash" : "bd980929010aef404e7cb0843e61d0665269fc39",
    "build_timestamp" : "2016-04-04T12:25:05Z",
    "build_snapshot" : false,
    "lucene_version" : "5.5.0"
  },
  "tagline" : "You Know, for Search"
}

</code></pre>
                <p class="fragment" data-code-focus="2"/>
                <p class="fragment" data-code-focus="4-15"/>
                <p class="fragment" data-code-focus="5"/>
                <p class="fragment" data-code-focus="6"/>
                <p class="fragment" data-code-focus="8"/>
            </section>
            <section>
            <pre><code>
curl -XPOST 'localhost:9200/conferences/conference/1?pretty' -d '
{
  "name": "Codemotion Amsterdam",
  "location": "Kromhouthal"
}'
			</code></pre>
                <pre><code>
{
  "_index" : "conferences",
  "_type" : "conference",
  "_id" : "1",
  "_version" : 1,
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "created" : true
}
                </code></pre>
                <p class="fragment" data-code-focus="2-6"/>
                <p class="fragment" data-code-focus="2"/>
                <p class="fragment" data-code-focus="3-6"/>
                <p class="fragment" data-code-focus="8-20"/>
                <p class="fragment" data-code-focus="18"/>
            </section>
            <aside class="notes">
                First show how easy it is to start you node / cluster, insert documents and query them.
            </aside>
        </section>


        <section>
            <h2>Wow, what just happened?</h2>
            <section>
                <p class="fragment">Started a cluster of one node</p>
                <p class="fragment">We created an index</p>
                <p class="fragment">Inserted a document</p>
            </section>
            <aside class="notes">
                Explain what just happens, created an index, used a certain number of shards, replicas, created a
                mapping. But there are a lot of choices to be made. This way only the defaults are used. These are often
                not what you want.
            </aside>
        </section>

        <section>
            <h2>Raises a lot of questions</h2>
            <img src="/lib/images/comingto/more-questions.png">
            <aside class="notes">
                But using defaults is not the right way for most of these questions?
            </aside>
        </section>

        <section>
            <h2>Design your cluster</h2>
            <section>
                <h3>Installation</h3>
                <p>Just download, unzip and run</p>
                <p>Use ansible scripts made available</p>
                <p>Use package manager: yum, apt</p>
            </section>
            <section>
                <h3>Configuration</h3>
                <p>/etc/defaults/elasticsearch</p>
                <p>/etc/elasticsearch/elasticsearch.yml</p>
                <aside class="notes">
                    Important to explain that elasticsearch.yml is used to configure the node and the other file is
                    meant to configure the process and pass some environment variables.
                </aside>
            </section>
            <section>
                <h3>/etc/defaults/elasticsearch</h3>
                <pre><code>
# Heap size defaults to 256m min, 1g max
# Set ES_HEAP_SIZE to 50% of available RAM, but no more than 31g
ES_HEAP_SIZE=2g
                </code></pre>
                <p class="fragment" data-code-focus="2-3"/>
                <p class="fragment" data-code-focus="4"/>
            </section>
            <section>
                <h3>/etc/elasticsearch/elasticsearch.yml</h3>
                <pre><code class="hljs">
cluster.name: playground
node.name: node-1
discovery.zen.ping.unicast.hosts: ["node-1", "node-2", "node-3"]
discovery.zen.minimum_master_nodes: 2
path.repo: /opt/es_snapshots/
script.inline: true
http.cors.enabled: true
                </code></pre>
                <p class="fragment" data-code-focus="2-3"/>
                <p class="fragment" data-code-focus="4-5"/>
                <p class="fragment" data-code-focus="6-8"/>
                <aside class="notes">
                    There is a lot to tell about scripting, there are so many fine grained options to configure what
                    you allow to do with scripts.
                    https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-scripting.html
                </aside>
            </section>

            <section>
                <p>How many nodes do I need?</p>
            </section>
            <section>
                <div style="float: left">
                    <img src="lib/images/cluster/1-node.png">
                </div>
                <div>
                    <p>Development / non-critical</p>
                </div>
            </section>
            <section>
                <div style="float: left">
                    <img src="lib/images/cluster/3-node.png">
                </div>
                <div>
                    <p>Small production</p>
                </div>
                <aside class="notes">
                    Think about split brain, minimum master nodes (n/2 + 1), Master is responsible for health of the
                    cluster
                </aside>
            </section>
            <section>
                <div style="float: left">
                    <img src="lib/images/cluster/n-node.png" width="80%">
                </div>
                <div>
                    <p>Large production</p>
                </div>
                <aside class="notes">
                    https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html
                </aside>
            </section>

            <section>
                <h3>Hardware</h3>
                <ul>
                    <li>Prefer cores over clock speed</li>
                    <li>Choose between 8-64Gb</li>
                    <li>Prefer SSD</li>
                </ul>
            </section>
            <aside class="notes">
                Talk about the number of nodes, the type of nodes, and a bit of connecting using clients.
            </aside>
        </section>

        <section>
            <h2>Design your indices</h2>
            <section>
                <img src="/lib/images/indices/overview.png">
            </section>
            <section>
                <img src="/lib/images/indices/playground.png">
            </section>
            <section>
                <img src="/lib/images/indices/playground-query.png">
            </section>
            <section>
                <img src="/lib/images/indices/logs.png">
            </section>
            <section>
                <img src="/lib/images/indices/logs-query.png">
            </section>
            <section>
                <p>MAYBE SHOW A REQUEST TO CREATE AN INDEX</p>
            </section>
            <section>
                <p>Specify the amount of shards</p>
                <ul>
                    <li class="fragment">Amount of docs or terms</li>
                    <li class="fragment">Indexing speeds</li>
                    <li class="fragment">Start small and test</li>
                    <li class="fragment">Why not a lot of shards?</li>
                    <li class="fragment">Not bigger than than 50Gb</li>
                </ul>
            </section>
            <!--<section>-->
            <!--<p>Maybe mention the _all field, can be expensive, especially if you do not need it.</p>-->
            <!--</section>-->
            <section>
                <p>Should I use types?</p>
            </section>
            <section>
                <p>Have time based indices, use Index Templates?</p>
            </section>
            <aside class="notes">
                So you have your cluster running, it has enough nodes and each node is configured with enough memory.
                A very important thing to consider is whether you are using time based indices. Than think about
                the amount of shards that you would need and of course the amount of replicas.
            </aside>
        </section>

        <section>
            <h2>Design your mapping</h2>
            <section>
                <p>Should I create my own mapping?</p>
            </section>
            <section>
                <p>A mapping is persistent, can only add new things.</p>
            </section>
            <section>
                <p>Create an index with one field: name</p>
                <pre><code class="hljs" data-trim contenteditable>
PUT /conferences
{
  "mappings": {
    "conference": {
      "properties": {
        "name": {
          "type": "string",
          "analyzer": "standard",
          "fields": {
            "raw": {
              "type": "string",
              "index": "not_analyzed"
            }
          }
        }
}}}}
                </code></pre>
                <p class="fragment" data-code-focus="6"/>
                <p class="fragment" data-code-focus="7-8"/>
                <p class="fragment" data-code-focus="9-14"/>
                <p class="fragment" data-code-focus="12"/>
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-base.png">
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-start.png">
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-charfilter.png">
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-tonizer.png">
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-tokenfilter.png">
            </section>
            <section>
                <img src="/lib/images/indices/analyzer-analyzer.png">
            </section>
            <section>
                <ul>
                    <li class="fragment">Choose the right analyzer for the job</li>
                    <li class="fragment">Do not analyze if you don't need it</li>
                </ul>
                <p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html">
                    https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html
                </a></p>
            </section>
        </section>

        <section>
            <h2>Indexing documents</h2>
            <section>
                <p><a href="https://www.elastic.co/products/beats">Beats</a></p>
                <p><a href="https://www.elastic.co/products/logstash">Logstash</a></p>
                <p><a href="https://github.com/jprante/elasticsearch-jdbc">jdbc-importer</a></p>
                <p>Create your own</p>
            </section>
            <section>
                <img src="/lib/images/indexing/base.png">
            </section>
            <section>
                <img src="/lib/images/indexing/index-doc.png">
            </section>
            <section>
                <img src="/lib/images/indexing/index-doc-2.png">
            </section>
            <section>
                <img src="/lib/images/indexing/refresh.png">
            </section>
            <section>
                <img src="/lib/images/indexing/more-docs.png">
            </section>
            <section>
                <img src="/lib/images/indexing/flush.png">
            </section>
            <section>
                <h3>Tips</h3>
                <ul>
                    <li class="fragment">Use Bulk</li>
                    <li class="fragment">Disable or decrease refresh rate</li>
                    <li class="fragment">Index without replicas</li>
                </ul>
            </section>
            <aside class="notes">
                <p>Chose the correct bulk size, usually each bulk should be between 5-15Mb</p>
                <p>Round-robin your bulk requests over the nodes, or one node could get flouded based on the memory
                    requirements of a bulk</p>
                https://www.elastic.co/guide/en/elasticsearch/guide/2.x/indexing-performance.html
            </aside>
        </section>

        <section>
            <h2>Querying documents</h2>
            <section>
                <pre><code class="hljs" data-trim contenteditable>
curl -XGET 'http://localhost:9200/_search'
                </code></pre>
            </section>
            <section>
                <pre><code data-trim>
curl -XGET 'http://localhost:9200/meetups/_search?
              q=venue.city:amsterdam%20AND%20description:elasticsearch
              &pretty'
                </code></pre>
            </section>
            <section>
                <pre><code data-trim>
curl -XGET "http://localhost:9200/meetups/_search" -d'
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "venue.city": "amsterdam"
          }
        },
        {
          "match": {
            "description": "elasticsearch"
          }
        }
      ]
}}}'
                </code></pre>
            </section>
            <section>
                <pre><code data-trim>
curl -XGET "http://localhost:9200/meetups/_search" -d'
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "description": "elasticsearch"
          }
        }
      ],
      "filter": {
        "term": {
          "venue.city.raw": "Amsterdam"
        }
      }
    }}}'
                </code></pre>
                <aside class="notes">
                    Talk about the difference between query and filter context. A query calculates a score, a filter
                    does not need a score. It is a yes/no answer. Also mention using the not_analyzed fields.
                </aside>
            </section>

            <section>
                <h3>Some query types available</h3>
                <ul>
                    <li>Full text - Match, Query String, Common Terms</li>
                    <li>Term level - Term, Range, Exist, Missing</li>
                    <li>Compound - Bool, Function score</li>
                    <li>Geo - GeoShape, Geo Bounding Box, Geo Distance</li>
                </ul>
            </section>
            <section>
                <p>Profile api to learn about the performance</p>
                <p>Explain api to learn about the scoring</p>
            </section>
            <section>
                <pre><code data-trim>
curl -XGET "http://localhost:9200/meetups/_search" -d'
{
  "query": {
    "function_score": {
      "query": {"match": {"_all": "elastic elasticsearch"}
      },
      "functions": [
        {
          "gauss": {
            "venue.location": {
              "origin": {
                "lat": 52.0607,
                "lon": 4.494
              },
              "scale": "2km"
            }
          }
        }
      ]
    }
  }
}'
                </code></pre>
            </section>
        </section>

        <section>
            <h2>Aggregations</h2>
            <section>
                <p>Maybe the reason why elasticsearch became so popular</p>
            </section>
            <section>
                <pre><code data-trim>
curl -XGET "http://localhost:9200/meetups/_search" -d'
{
  "size": 0,
  "aggs": {
    "byCity": {
      "terms": {
        "field": "venue.city.raw",
        "size": 10
      }
    }
  }
}'
                </code></pre>
            </section>
            <section>
                <p>Inverted index not suitable for aggregations</p>
            </section>
            <section>
                <h3>doc_values</h3>
                <p>Stored on disk</p>
                <p>All fields except analyzed strings</p>
                <p>Make use of columnar storage</p>
            </section>
            <section>
                <h3>fielddata</h3>
                <p>For analyzed strings</p>
                <p>Stored in the heap</p>
            </section>
        </section>

        <section>
            <h2>Monitoring the cluster</h2>
            <section>
                <pre><code data-trim>GET /_cluster/health</code></pre>
                <pre><code data-trim>
{
  "cluster_name": "playground",
  "status": "yellow",
  "timed_out": false,
  "number_of_nodes": 1,
  "number_of_data_nodes": 1,
  "active_primary_shards": 55,
  "active_shards": 55,
  "relocating_shards": 0,
  "initializing_shards": 0,
  "unassigned_shards": 16,
  "delayed_unassigned_shards": 0,
  "number_of_pending_tasks": 0,
  "number_of_in_flight_fetch": 0,
  "task_max_waiting_in_queue_millis": 0,
  "active_shards_percent_as_number": 77.46478873239437
}
                </code></pre>
                <p class="fragment" data-code-focus="3"/>
                <p class="fragment" data-code-focus="11"/>
            </section>
            <section>
                <pre><code data-trim>GET /_cluster/health?level=indices</code></pre>
                <pre><code data-trim>
"indices": {
    "conferences": {
      "status": "yellow",
      "number_of_shards": 5,
      "number_of_replicas": 1,
      "active_primary_shards": 5,
      "active_shards": 5,
      "relocating_shards": 0,
      "initializing_shards": 0,
      "unassigned_shards": 5
    }
}
                </code></pre>
                <p class="fragment" data-code-focus="3"/>
                <p class="fragment" data-code-focus="5"/>
                <p class="fragment" data-code-focus="10"/>
            </section>
            <section>
                <pre><code data-trim>GET /_nodes/stats?human</code></pre>
                <ul>
                    <li class="fragment">indices - field_data, filter_cache</li>
                    <li class="fragment">os - cpu, memory, load</li>
                    <li class="fragment">process - file descriptors, cpu, memory</li>
                    <li class="fragment">jvm - memory, garbage collection</li>
                    <li class="fragment">thread_pool - threads, rejected</li>
                    <li class="fragment">fs - disk space</li>
                </ul>
                <aside class="notes">
                    Stats can also be requested for the complete cluster or only for a specific index.
                </aside>
            </section>
            <section>
                <pre><code data-trim>GET /_cluster/pending_tasks</code></pre>
                <p>Should return an empty array, but ...</p>
            </section>
            <section>
                <h3>_cat api</h3>
                <pre class="fragment"><code data-trim>GET /_cat/health?v</code></pre>
                <pre class="fragment"><code data-trim>GET /_cat/indices?v</code></pre>
                <pre class="fragment"><code data-trim>GET /_cat/fielddata?v</code></pre>
            </section>
            <section>
                <p>Using tools like Marvel</p>
            </section>
        </section>
        <section>
            <h2>Logging</h2>
            <section>
                <p>Can be changed dynamically</p>
                <pre><code data-trim>
PUT /_cluster/settings
{
    "transient" : {
        "logger.discovery" : "DEBUG"
    }
}                </code></pre>
            </section>
            <section>
                <h3>Slowlog</h3>
                <pre><code data-trim>
PUT /meetups/_settings
{
    "index.search.slowlog.threshold.query.warn" : "10s",
    "index.search.slowlog.threshold.fetch.debug": "500ms",
    "index.indexing.slowlog.threshold.index.info": "5s"
}
                </code></pre>
                <pre><code data-trim>
PUT /_cluster/settings
{
    "transient" : {
        "logger.index.search.slowlog" : "DEBUG",
        "logger.index.indexing.slowlog" : "WARN"
    }
}                </code></pre>
            </section>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
//            {
//                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
//                hljs.initHighlightingOnLoad();
//            }
//            },
            {src: 'lib/js/vendor/highlight.pack.js'},
            {
                src: 'node_modules/reveal-code-focus/reveal-code-focus.js',
                async: true,
                callback: function () {
                    RevealCodeFocus();
                    hljs.registerLanguage('javascript');
                }
            },
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/notes/notes.js', async: true}
        ]
    });

</script>

</body>
</html>
