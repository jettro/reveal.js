<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>Making your elastic cluster perform</title>

    <meta name="description" content="A presentation explaining the steps to take to run a healthy elastic cluster">
    <meta name="author" content="Jettro Coenradie">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/solarized.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <!-- Any section element inside of this container is displayed as a slide -->
    <div class="slides">
        <section>
            <h1>TODO</h1>
            <ul>
                <li>https://demoneaux.github.io/reveal-code-focus/#/</li>
                <li>https://www.elastic.co/elasticon/conf/2016/sf/elasticsearch-and-resiliency</li>
                <li>
                    https://www.elastic.co/elasticon/conf/2016/sf/stories-from-elastic-support-top-problems-and-solutions
                </li>
            </ul>
        </section>
        <section>
            <h1>Making your elastic cluster perform</h1>
            <p>
                <small>Created by <a href="http://twitter.com/jettroCoenradie">@jettroCoenradie</a></small>
            </p>
            <p>
                <img src="/lib/images/luminisams_logo.png">
            </p>
        </section>

        <section>
            <h2>Beginning with Elasticsearch</h2>
            <section data-background="/lib/images/elastic-cluster-full-color.jpg">
            </section>
            <section>
                <img src="/lib/images/firststeps/downloading-elasticsearch.png">
            </section>
            <section>
                <img src="/lib/images/firststeps/starting-elasticsearch.png">
            </section>
            <section>
            <pre><code class="hljs" data-trim contenteditable>
curl 'localhost:9200?pretty'
			</code></pre>
                <p>
                    Response
                </p>
<pre><code class="hljs" data-trim contenteditable>{
  "name" : "Tatterdemalion",
  "cluster_name" : "elasticsearch",
  "version" : {
    "number" : "2.3.1",
    "build_hash" : "bd980929010aef404e7cb0843e61d0665269fc39",
    "build_timestamp" : "2016-04-04T12:25:05Z",
    "build_snapshot" : false,
    "lucene_version" : "5.5.0"
  },
  "tagline" : "You Know, for Search"
}</code></pre>
            </section>
            <section>
            <pre><code class="hljs" data-trim contenteditable>
curl -XPOST 'localhost:9200/conferences/conference/1?pretty' -d '
{
  "name": "Codemotion Amsterdam",
  "location": "Kromhouthal"
}'
			</code></pre>
                <p>
                    Response
                </p>
                <pre><code class="hljs" data-trim contenteditable>{
  "_index" : "conferences",
  "_type" : "conference",
  "_id" : "1",
  "_version" : 1,
  "_shards" : {
    "total" : 2,
    "successful" : 1,
    "failed" : 0
  },
  "created" : true
}</code></pre>
            </section>
            <aside class="notes">
                First show how easy it is to start you node / cluster, insert documents and query them.
            </aside>
        </section>


        <section>
            <h2>Wow, what just happened?</h2>
            <section>
                <p class="fragment">Started a cluster and a node</p>
                <p class="fragment">We created an index</p>
                <p class="fragment">The index was created with a number of shards and replicas</p>
                <p class="fragment">The mapping was created for the fields we provided</p>
            </section>
            <section>
                <p>All using the defaults</p>
            </section>
            <section>
                <table>
                    <thead>
                    <tr>
                        <th></th>
                        <th>default value</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>cluster name</td>
                        <td>elasticsearch</td>
                    </tr>
                    <tr class="fragment">
                        <td>node name</td>
                        <td>random marvel character</td>
                    </tr>
                    <tr class="fragment">
                        <td>num shards</td>
                        <td>5</td>
                    </tr>
                    <tr class="fragment">
                        <td>num replicas</td>
                        <td>1</td>
                    </tr>
                    <tr class="fragment">
                        <td>mappings</td>
                        <td>2 string fields</td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section>
                <p>That is a lot of defaults, but ...</p>
            </section>
            <aside class="notes">
                Explain what just happens, created an index, used a certain number of shards, replicas, created a
                mapping
            </aside>
        </section>

        <section>
            <h2>More questions than answers</h2>
            <ul>
                <li class="fragment">How many nodes?</li>
                <li class="fragment">How many shards?</li>
                <li class="fragment">How many replicas?</li>
                <li class="fragment">Provide a mapping?</li>
                <li class="fragment">Time based indices?</li>
                <li class="fragment">Can I change mappings?</li>
                <li class="fragment">Should I monitor my cluster?</li>
                <li class="fragment">What if queries are slow?</li>
                <li class="fragment">What if indexing takes to much time?</li>
            </ul>
            <aside class="notes">
                But using defaults is not the right way for most of these questions?
            </aside>
        </section>

        <section>
            <h2>Design your cluster</h2>
            <section>
                <p>How many nodes do I need?</p>
                <p>Think about split brain, minimum master nodes (n/2 + 1)</p>
                <p>Master is responsible for health of the cluster</p>
                <p>Create images with different setups</p>
            </section>
            <section>
                <p>Some reference numbers coming from elastic support</p>
                <p>Referentie naar presentatie geven</p>
                <p>Use max of 50% of your machine RAM for elastic</p>
                <p>Do not appoint more than 30500Mb RAM</p>
            </section>

            <aside class="notes">
                Talk about the number of nodes, the type of nodes, and a bit of connecting using clients. As a side step
                we could talk about security here, but I am not sure yet.
            </aside>
        </section>

        <section>
            <h2>Design your indices</h2>
            <section>
                <p>Create an image explaining what happens when you do a query (Index, shard, Lucene)</p>
            </section>
            <section>
                <p>Specify the amount of shards</p>
            </section>
            <section>
                <ul>
                    <li>Amount of docs or terms</li>
                    <li>Indexing speeds</li>
                    <li>Start small and test</li>
                    <li>Why not a lot of shards?</li>
                </ul>
            </section>
            <section>
                <p>Some reference numbers coming from elastic support</p>
                <p>Referentie naar presentatie geven</p>
                <p>Try not to make bigger shards than 50Gb</p>
            </section>
            <section>
                <p>Do you have time based indices?</p>
            </section>
            <section>
                <p>Maybe mention the _all field, can be expensive, especially if you do not need it.</p>
            </section>
            <section>
                <p>Should I use types?</p>
            </section>
            <aside class="notes">
                A very important thing to consider is whether you are using time based indices. Than think about
                the amount of shards that you would need and of course the amount of replicas.
            </aside>
        </section>

        <section>
            <h2>Design your mapping</h2>
            <section>
                <p>Maybe the hardest thing to do in the beginning.</p>
            </section>
            <section>
                <p>Why?</p>
            </section>
            <section>
                <p>A mapping is persistent, can only add new things.</p>
            </section>
            <section>
                <p>Create an index with one field: name</p>
                <pre><code class="hljs" data-trim contenteditable>
PUT /conferences
{
  "mappings": {
    "conference": {
      "properties": {
        "name": {
          "type": "string"
        }
      }
    }
  }
}
                </code></pre>
            </section>
            <section>
                <p>Retrieve the created mapping for the index</p>
                <pre><code class="hljs" data-trim contenteditable>
GET /conferences/_mapping

{
  "conferences": {
    "mappings": {
      "conference": {
        "properties": {
          "name": {
            "type": "string"
          }
        }
      }
    }
  }
}
                </code></pre>
            </section>
            <section>
                <p>The field is analyzed with the (default) standard analyzer</p>
            </section>
            <section>
                <p>What is an analyzer?</p>
                <p>Hier wil ik een plaatje hebben die laat zien wat een analyzer doet</p>
            </section>
            <section>
                <p>Most used analyzers (But there are a lot more)</p>
                <p>Tabel met analyzers</p>
            </section>
            <section>
                <p>We can analyze the same field multiple times</p>
                <p>Moeten hier even een code voorbeeld geven</p>
            </section>
            <section>
                <p>Not analyzed fields, can work with doc_values.</p>
                <p>Big advantage for sorting and aggregations</p>
            </section>
            <section>
                <p>Doc_values ?????</p>
            </section>
            <section>
                <p>From 2.3 use the keyword fields?????</p>
            </section>
            <section>
                <p>Structuring you model: objects - nested - parent/child</p>
            </section>
        </section>

        <section>
            <h2>Indexing documents</h2>
            <section>
                <p><a href="https://www.elastic.co/products/beats">Beats</a></p>
                <p><a href="https://www.elastic.co/products/logstash">Logstash</a></p>
                <p><a href="https://github.com/jprante/elasticsearch-jdbc">jdbc-importer</a></p>
                <p>Roll you own</p>
            </section>
            <section>
                <p>Use Bulk</p>
                <p>Experiment with Bulk size</p>
                <p>Handle the bulk response</p>
                <p>Think about refresh</p>
                <p>Misschien een plaatje met wat het betekend</p>
                <p>Think about the replicas</p>
            </section>
        </section>

        <section>
            <h2>Querying documents</h2>
            <section>
                <p>There are a lot of different quesries available.</p>
                <p>Know the queries that are cache-able queries</p>
                <p>Filter as much as possible on non_analyzed fields</p>
                <p>Make combinations of queries</p>
            </section>
            <section>
                <p>Sometimes two consecutive queries are better than one big one. </p>
            </section>
            <section>
                <p>Use the profile api to learn about the performance of your query</p>
                <p>Use the explain api to learn about the scoring</p>
            </section>
        </section>

        <section>
            <h2>Monitoring the cluster</h2>
            <section>
                <p>The manual way, using the _cat api</p>
            </section>
            <section>
                <p>Using tools like Marvel</p>
            </section>
            <section>
                <p>What to look out for?</p>
                <ul>
                    <li>Garbage collection</li>
                    <li>Thread pools</li>
                </ul>
            </section>
        </section>
    </div>

</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/highlight/highlight.js', async: true, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/notes/notes.js', async: true}
        ]
    });

</script>

</body>
</html>
